########################################
#---- Run the mydef scripts directly 

page: mydef_run
    output_dir: script
    type:

    use MyDef
    my %config
    $call parse_arg
    $call guess_module
    MyDef::init(%config)
    MyDef::import_data($config{def_file})
    my $pagename=$MyDef::def->{pagelist}->[0]
    $if $pagename
        MyDef::createpage($pagename)
    $elif -f "run"
        system "sh run"
    $elif -f "Makefile"
        system "make"

    $if !$config{skiprun}
        $if $pagename
            $call run_page

    # -------------------------
    subcode: parse_arg
        $foreach $a in @ARGV
            $if $a=~/-m(\w+)$/
                $config{module}=$1
            $elif $a=~/(.*)\.def/
                $config{def_file}=$a

        $if !$config{def_file}
            die "Usage: $0 input_defile.def\n"

    subcode: guess_module
        $config{module}="perl"
        &call open_r, $config{def_file}
            $if /module:\s*(\w+)/
                $config{module}=$1
                last
            $elif /^#skiprun/
                $config{skiprun}=1

    subcode: run_page
        my $page=$MyDef::page
        my $name=$page->{outname}
        my ($exe, $cmd)
        $if $name=~/(.*)\.c(pp)?$/
            $exe=$1
            my $cc = "gcc"
            my $cflags
            $if $page->{CFLAGS}
                $cflags = $page->{CFLAGS}
            $if $page->{make} eq "win32"
                $cc = "/usr/bin/x86_64-w64-mingw32-gcc"
                $cmd = "$cc -o$exe.exe $name $cflags $page->{lib_list}"
            $elif $config{module} eq "win32"
                $cc = "/usr/bin/x86_64-w64-mingw32-gcc"
                $cmd = "$cc -o$exe.exe $name $cflags $page->{lib_list} -Wl,--subsystem,windows"
            $else
                $if $name=~/\.cpp$/
                    $cc = "g++"
                $cmd="$cc -g $cflags -o$exe $name $page->{lib_list}"
            $call append_run, $exe
        $elif $name=~/(.*)\.f$/
            $exe = $1
            $cmd="gfortran -g -o$exe $name $page->{lib_list}"
            $call append_run, $exe
        $elif $name=~/\.java$/
            $name=~s/\//./g
            $name=~s/\.java$//
            $cmd="javac $name"
            $call append_run, java $name
        $elif $page->{run}
            $cmd=$page->{run}
        $call do_script, pl, perl
        $call do_script, sh, sh
        $call do_script, py, python
        $call do_script, go, go run
        $call do_script, tex, pdflatex
        $call do_script, awk, awk -f

        $if $cmd
            $call append_arg
            $print $cmd
            system $cmd
        $else
            die "do not know how to run it\n"

        # --------------------
        subcode: do_script(ext, cmd)
            $case $name=~/\.$(ext)$/
                $cmd = "$(cmd) $name"

        subcode: append_run(exe)
            $if $page->{run}
                $cmd .= " && $page->{run}"
            $else
                $cmd .= " && $(exe)"

        subcode: append_arg
            $if $page->{arg}
                $cmd .= " $page->{arg}"

