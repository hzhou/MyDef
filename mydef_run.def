include: custom_run.def?
########################################
#---- Run the mydef scripts directly 

page: mydef_run
    output_dir: script
    type:

    use MyDef
    my (%config, $pagename)
    my $page
    $call parse_arg
    $if $config{def_file}
        $call guess_module
        # reads in config file
        MyDef::init(%config)
        # reads in def file
        MyDef::import_data($config{def_file})
        $if !$pagename
            $pagename=$MyDef::def->{pagelist}->[0]
        $if $pagename
            MyDef::createpage($pagename)
            $page=$MyDef::page
            $if $page->{skiprun}
                # $call run_page
                exit
        $else
            exit
    $elif $config{_file}
        $page={outname=>$config{_file}}
    $else
        die "Usage: $0 input_defile.def\n"

    $call run_page

    # -------------------------
    subcode: parse_arg
        $foreach $a in @ARGV
            $if $a=~/-m(\w+)$/
                $config{module}=$1
            $elif $a=~/-rule$/
                $config{dump_rule}=1
            $elif $a=~/(.*)\.def/
                # compile && run_page
                $config{def_file}=$a
            $elif -f $a
                # just run_page
                $config{_file}=$a

    subcode: guess_module
        guess_module:
        my $under_page
        &call open_r, $config{def_file}
            $if /^page:\s*(\w+)/
                $under_page = $1
            $if /module:\s*(\w+)/
                $if !$config{module} or $pagename eq $under_page
                    $config{module}=$1
                # last
            $elif /^run:\s*(\S+\.def)/
                $config{def_file}=$1
                goto guess_module
            $elif /^run:\s*(\w+)/
                $pagename = $1
            $elif /^prerun:\s*(.+)/
                system $1
            $elif /^\/\*\s*expect (\S+):\s*$/
                $config{expect_type}=$1
                $call grab_expect_block
        $if !$config{module}
            $config{module}=$MyDef::var->{module}
        $if !$config{module}
            $config{module}="general"

    subcode: guess_os
        my $ostype
        # $ENV{OSTYPE} dissappears in perl
        my $uname = `uname`
        $if $uname=~/CYGWIN/
            $ostype = "cygwin"
        $else
            $ostype = "linux"

    subcode: run_page
        # $call guess_os
        my $file=$page->{outname}

        my $file_dir
        $if $file=~/(.*)\/(.+)/
            $file_dir=$1
            # chdir $1
            # $file=$2
        my ($name, $type)
        $if $file=~/^(.*)\.(\w+)$/
            ($name, $type)=($1, $2)

        my $exe = "$name"
        $if $config{module} eq "win32"
            $exe .= ".exe"
        my $cmd
        $if $type=~/^c(pp)?$/
            $call run_c
        $call do_compile, java, javac $file, CD java $name
        $call do_compile, f, gfortran -g -o$exe $file $page->{lib_list}, $exe
        $call do_compile, rs, rustc $file, $exe
        $call do_compile, hs, ghc -o$exe $file, $exe
        $call do_compile, asm, nasm -f elf $file && ld -m elf_i386 $name.o -o$exe, $exe
        # $call do_compile, prolog, gplc $name    ? no idea how to make it work
        $elif $page->{run}
            $cmd=$page->{run}
        $call do_script, sh, sh
        $call do_script, pl, perl
        $call do_script, php, php
        $call do_script, py, python
        $call do_script, go, go run
        $call do_script, js, node
        $call do_script, tcl, tclsh
        $call do_script, lisp, clisp
        # $call do_script, tex, pdflatex  # -interaction=batchmode
        $call do_script, tex, run_tex
        $call do_script, latex, run_tex
        $call do_script, awk, awk -f
        # --------------------------------
        $if $config{expect} and $name=~/\b$config{expect_type}$/
            $call cmp_expect, $name
        $elif $cmd
            $call append_arg
            $if $config{expect_type} eq "output"
                $call run_cmd_expect
            $else
                $print $cmd
                system $cmd
        $else
            die "do not know how to run it\n"

        # --------------------
        subcode: do_compile(ext, cmd, run)
            $case $type eq "$(ext)"
                $(if:$(ext)_CMD)
                    $(set:cmd=$($(ext)_CMD))
                $(if:$(ext)_RUN)
                    $(set:run=$($(ext)_RUN))

                $cmd="$(cmd)"
                $call append_run, $(run)

        subcode: do_script(ext, cmd)
            $case $type eq "$(ext)"
                $cmd = "$(cmd) $file"

        subcode: append_run(exe)
            $(if:exe=$exe)
                $if $exe!~/\//
                    $exe = "./$(exe)"
            my $run = "$(exe)"
            $call set_config, $run, run
            $if $run ne "none"
                $if $file_dir and $run=~/CD\s+(.*)/
                    my $t = $1
                    $t=~s/$file_dir\///g
                    $run = "chdir $file_dir && $t"
                $cmd .= " && $run"

        subcode: append_arg
            $if $page->{arg}
                $cmd .= " $page->{arg}"

        subcode: set_config(var, key)
            $if $page->{$(key)}
                $(var) = $page->{$(key)}
            $elif $MyDef::var->{$(key)}
                $(var) = $MyDef::var->{$(key)}

        # --------------------------
        subcode: run_cmd_expect
            $if $cmd=~/(.*) && (.*)/
                $print $1
                system $1
                $if $? == -1
                    die "failed to compile\n"
                $elif $? & 0xff
                    die "compile failure\n"
                $cmd = $2

            $call cmp_expect, cmd

        # ------------------------
        subcode: run_c
            $(if:CC)
                my $cc="$(CC)"
            $(else)
                my $cc = "gcc -std=c99 -O2"
                # my $cc = "gcc"
                # my $cc = "gcc -std=gnu99"
                # my $cc = "x86_64-w64-mingw32-gcc"
                # my $cc = "x86_64-w64-mingw32-gcc -O2 -Wl,--subsystem,windows"
            $if $name=~/\.cpp$/
                $cc = "g++ -O2"

            $call set_config, $cc, CC
            # ---------------------
            $cmd="$cc -o$exe $file $page->{lib_list}"

            $if $config{dump_rule}
                $if $exe=~/([^\/]+)$/
                    $exe = "script/$1"
                $if $name=~/([^\/]+)$/
                    $name = "$1"
                $cmd = '$'."{CC} -o\$@ \$< $page->{lib_list}"
                print "\nCC=$cc\n\n"
                print "$exe: $name\n"
                print "\t$cmd\n"
                exit
            $else
                $call append_run, $exe

#---------------------------------------- 
subcode: grab_expect_block
    my @expect
    $while <In>
        $if /^\*\//
            $config{expect} = \@expect
            last
        $else
            $call @expect_normalize
            push @expect, $_

subcode: cmp_expect(type)
    my $expect = $config{expect}
    my $i = 0
    my ($n_ok, $n_nok)
    $(if:type=cmd)
        $print $cmd
        $(set:output="$cmd |")
    $(else)
        $(set:output=$name)

    &call open_r, $(output)
        print $_
        $call expect_normalize
        $if $expect->[$i] ne $_
            $n_nok++
            $print "not ok: [$expect->[$i]]"
        $else
            $n_ok++
        $i++
    print "--------------------------\n"
    $if $n_ok>0
        $print "    $green{ok} $n_ok/$i"
    $if $n_nok>0
        $print "    $red{not ok} $n_nok/$i"

subcode: expect_normalize
    s/\s+/ /g
    s/\s*$//g

