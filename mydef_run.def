########################################
#---- Run the mydef scripts directly 

page: mydef_run
    output_dir: script
    type:

    use MyDef
    my %config
    $call parse_arg
    $call guess_module
    MyDef::init(%config)
    MyDef::import_data($config{def_file})
    my $pagename=$MyDef::def->{pagelist}->[0]
    $if $pagename
        MyDef::createpage($pagename)
    $elif -f "run"
        system "sh run"
    $elif -f "Makefile"
        system "make"

    $if !$config{skiprun}
        $if $pagename
            $call run_page

    # -------------------------
    subcode: parse_arg
        $foreach $a in @ARGV
            $if $a=~/-m(\w+)$/
                $config{module}=$1
            $elif $a=~/(.*)\.def/
                $config{def_file}=$a

        $if !$config{def_file}
            die "Usage: $0 input_defile.def\n"

    subcode: guess_module
        $config{module}="perl"
        &call open_r, $config{def_file}
            $if /module:\s*(\w+)/
                $config{module}=$1
                last
            $elif /^#skiprun/
                $config{skiprun}=1

    subcode: run_page
        my $page=$MyDef::page
        my $name=$page->{outname}
        my $cmd_line = $page->{run}
        my ($exe, $cmd)
        $if $name=~/(.*)\.c(pp)?$/
            $exe=$1
            my $cc = "gcc"
            my $cflags
            $if $page->{CFLAGS}
                $cflags = $page->{CFLAGS}
            $if $page->{make} eq "win32"
                $cc = "/usr/bin/x86_64-w64-mingw32-gcc"
                $cmd = "$cc -o$exe.exe $name $cflags $page->{lib_list}"
            $elif $config{module} eq "win32"
                $cc = "/usr/bin/x86_64-w64-mingw32-gcc"
                $cmd = "$cc -o$exe.exe $name $cflags $page->{lib_list} -Wl,--subsystem,windows"
            $else
                $if $name=~/\.cpp$/
                    $cc = "g++"
                $cmd="$cc -g $cflags -o$exe $name $page->{lib_list}"
                $if !$cmd_line
                    $cmd_line = "$exe"
        $elif $name=~/(.*)\.f$/
            $exe = $1
            $cmd="gfortran -g -o$exe $name $page->{lib_list}"
            $if !$cmd_line
                $cmd_line = "$exe"
        $elif $name=~/\.java$/
            $name=~s/\//./g
            $name=~s/\.java$//
            $cmd="javac $name"
            $if !$cmd_line
                $cmd_line = "java $name"
        $elif $cmd_line
            $cmd=$cmd_line
            undef $cmd_line
        $else
            $if $name=~/\.pl$/
                $cmd="perl $name"
            $elif $name=~/\.sh$/
                $cmd="sh $name"
            $elif $name=~/\.py$/
                $cmd="python $name"
            $elif $name=~/\.tex$/
                $cmd="pdflatex $name"

        $if $cmd
            $if $cmd_line
                $cmd .= " && $cmd_line"
            $print $cmd
            system $cmd
        $else
            die "do not know how to run it\n"
            
