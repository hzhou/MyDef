page: mydef_page
    output_dir: script
    type:
    subcode: main
        #Usage: perl createpages.pl def_file
        use MyDef;
        my $def_file
        my %config;
        my $default_module=$MyDef::var->{module}
        $call parse_arg

        $if $def_file eq "-pipe"
            #-- reads from STDIN
            #-- dump to STDOUT
            MyDef::pipe_page($config{module})
        $else
            $config{def_file}=$def_file

            MyDef::init(%config);
            my $module=$MyDef::var->{module}
            MyDef::import_data($def_file)

            $if $config{find}
                $call find_subcode
            $else
                $call compile_pages

    # ---------------------------------------- 
    subcode: parse_arg
        $foreach $a in @ARGV
            $if $a =~ /^-m(\w+)/
                $config{module} = $1
            $elif $a =~/^-o(\S+)/
                $config{output_dir} = $1
            $elif $a =~/^-f(\S+)/
                $config{find} = $1
            $elif $a=~/\.def$/
                $if $def_file
                    die "Multiple def source files not supported\n"
                $if -f $a
                    $def_file=$a
                $else
                    die "$a is not a regular file\n"
            $elif $a eq "-pipe"
                $def_file="-pipe"

        $if !$def_file
            die "Please supply data definition file.";

    # ---------------------------------------- 
    subcode: find_subcode
        my $def=$MyDef::def
        my $name=$config{find}
        $if $def->{codes}->{$name}
            my $code=$def->{codes}->{$name}
            $call dump_code
        $elif $def->{macros}->{$name}
            $print macro: $name: $def->{macros}->{$name}
        $else
            $print name: $name not found.

        subcode: dump_code
            my $type=$code->{type}
            my $param=join ", ", @{$code->{params}}
            my $source=$code->{source}
            my $indent=1
            print $type, "code: $name($param)\n"
            $foreach $l in @$source
                $if $l=~/^SOURCE_INDENT/
                    $indent++
                $elif $l=~/^SOURCE_DEDENT/
                    $indent--
                $else
                    print "    "x$indent, $l, "\n"

    # ---------------------------------------- 
    subcode: compile_pages
        my $pages=$MyDef::def->{pages}
        my $pagelist=$MyDef::def->{pagelist}

        $foreach $t in @$pagelist
            my $p=$pages->{$t}
            $if $p->{subpage}
                next

            my $t_module=$default_module
            $if $p->{module} 
                $t_module=$p->{module}
            $if $t_module and ($t_module ne $module)
                $print "skip page $t: module mismatch [page:$t_module][config:$module]"
                next

            MyDef::createpage($t);

########################################
#---- Run the mydef scripts directly 

page: mydef_run
    output_dir: script
    type:

    use MyDef
    my %config
    $call parse_arg
    $call guess_module
    MyDef::init(%config)
    MyDef::import_data($config{def_file})
    $call compile_page
    $call run

    # -------------------------
    subcode: parse_arg
        $foreach $a in @ARGV
            $if $a=~/-m(\w+)/
                $config{module}=$1
            $elif $a=~/(.*)\.def/
                $config{def_file}=$a

        $if !$config{def_file}
            die "Usage: $0 input_defile.def\n"

    subcode: guess_module
        $config{module}="perl"
        &call open_r, $config{def_file}
            $if /module:\s*(\w+)/
                $config{module}=$1
                last

    subcode: compile_page
        my $pagename=$MyDef::def->{pagelist}->[0]
        MyDef::createpage($pagename)

    subcode: run
        my $page=$MyDef::page
        my $name=$page->{outname}
        my $cmd
        $if $name=~/\.pl$/
            $cmd="perl $name"
        $elif $name=~/\.py$/
            $cmd="python $name"
        $elif $name=~/\.c$/
            $cmd="gcc -o$pagename $name $page->{lib_list} && ./$pagename"
        $elif $name=~/\.java$/
            $name=~s/\//./g
            $name=~s/\.java$//
            $cmd="javac $name && java $name"
        $elif $name=~/\.tex$/
            $cmd="pdflatex $name"

        $if $cmd
            $print $cmd
            system $cmd
        $else
            die "do not know how to run it\n"
            


