include: modules.def

page: MyDef
    type: pm
    output_dir: lib
    package: MyDef

    subcode: main
	$call mydef_main

subcode: mydef_main
    our $def;
    our $page;
    our $var={};
    use MyDef::utils
    use MyDef::parseutil
    use MyDef::compileutil
    use MyDef::dumpout

    # ----------------------------------
    import_config("config");
    my @include_path=split /:/, $var->{include_path}
    $if $ENV{MYDEFLIB}
	my $mydeflib=$ENV{MYDEFLIB}
	my @t
	$foreach $d in @include_path
	    $if $d=~/^\w+/ and -d "$mydeflib/$d"
		push @t, "$mydeflib/$d"
	$var->{include_path}.=":$ENV{MYDEFLIB}";
	$if @t
	    $var->{include_path}.=":". join(":", @t)

    $sub init
	my (%config)=@_;
	$while my ($k, $v) = each %config
	    $var->{$k}=$v;
	my $module=$var->{module};
	$if !$module
	    die "Module type not defined in config!\n"
	$map require_module, $(module_list)
	$else
	    die "Undefined module type $module\n";
    # ----
    $call mydef_subs
    1;

subcode: mydef_subs
    $sub addpath
	my ($path)=@_;
	$var->{path}=$path;

    $sub import_data($file)
	$def= MyDef::parseutil::import_data($file)

    $sub createpage
	my ($pagename)=@_;
	$page=$def->{pages}->{$pagename};
	$if $page->{output_path} and !$page->{output_dir}
	    $page->{output_dir}=$page->{output_path}

	my $plines=MyDef::compileutil::compile()
	MyDef::compileutil::output($plines)

    $sub is_sub
	my $subname=shift;
	$if $page->{codes}->{$subname}
	    return 1;
	$elsif $def->{codes}->{$subname}
	    return 1;
	$else
	    return 0;

    $sub set_page_extension($default_ext)
	my $ext=$default_ext
	$if exists $var->{filetype}
	    $ext=$var->{filetype}
	$if exists $page->{type}
	    $ext=$page->{type};
	$if $ext eq "none"
	    $ext=""

	$page->{pageext}=$ext 

    # --------------------------
    $sub import_config
	my ($file)=@_;
	# print STDERR "Reading Config File:  $file\n";
	open In, $file or return;
	$while <In>
	    $if /^(\w+):\s*(.*\S)/
		$var->{$1}=$2;
	close In;
	
	$if $var->{output_path} and !$var->{output_dir}
	    $var->{output_dir}=$var->{output_path}

################################################
subcode: require_module(name)
    $elif $module eq "$(name)"
	require MyDef::output_$(name);
	MyDef::compileutil::set_interface(MyDef::output_$(name)::get_interface());

