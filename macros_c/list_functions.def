subcode: parsecode_post
    $global @list_function_list

    $call check_autoload_h
    $if !$autoload_h
	$while my $f=shift @list_function_list
	    $call parse_function_list_item, $f
	    $call add_to_autoload_h, "function-$f"

# ------------------------------------
subcode:: parsecode_func_other
    $elsif $func eq "function"
	$call parse_function
	return
    $elsif $func eq "function_end"
	# automatically generated from compileutil
	$call parse_function_end
	return
    $elsif $func eq "list"
	# $call parse_function_list
	$call add_list_functions, $param
	return
    $elsif $func eq "fcall"
	$if $param=~/(\w+)\(/
	    $call add_list_function, $1
	    $l=$param
	$elif $param=~/^(\w+)\s*$/
	    $call add_list_function, $1
	    $l="$1()"

# ------------------------------------
subcode: add_list_functions(param)
    $global %list_function_hash

    my @tlist=split /,\s*/, $(param)
    $foreach $f in @tlist
	$call add_list_function, $f

subcode: add_list_function(f)
    $if !$list_function_hash{$(f)}
	$list_function_hash{$(f)}=1
	push @list_function_list, $(f)
    $else
	$list_function_hash{$(f)}++

# ------------------------------------
subcode: parse_function_list_item(f)
    my $funcname=$(f)
    my $codename=$(f)
    $if $f=~/(\w+)\((\w+)\)/
	$codename=$1
	$funcname=$2
    $funcname=~s/^@//
    my $params=MyDef::compileutil::get_sub_param_list($codename)
    $if defined $params
	my $paramline=join(",", @$params)
	$if $funcname eq "n_main" or $funcname eq "main2"
	    $funcname="main";
	my $fidx=open_function($funcname, $paramline);
	push @$out, "OPEN_FUNC_$fidx";
	$cur_indent=1
	push @$out, "SOURCE_INDENT"
	MyDef::compileutil::set_current_macro("FunctionName", $funcname)
	MyDef::compileutil::call_sub($codename, "\$list")
	$call parse_function_end
	push @$out, "SOURCE_DEDENT"

# ---- Direct $function ------------------
subcode: parse_function
    $call check_autoload_h
    $if !$autoload_h and $param=~/(\w+)(.*)/
	my ($fname, $paramline)=($1, $2)
	$if $paramline=~/\((.*)\)/
	    $paramline=$1
	$elif $paramline=~/^\s*,\s*(.*)/
	    $paramline=$1
	my $fidx=open_function($fname, $paramline)
	push @$out, "OPEN_FUNC_$fidx";
	push @$out, "SOURCE_INDENT";
	push @$out, "BLOCK";
	push @$out, "SOURCE_DEDENT";
	$call add_to_autoload_h, "function-$fname"
	return "NEWBLOCK-\$function_end";
    $else
	return "SKIPBLOCK"

subcode: parse_function_end
    $call case_reset
    $cur_function=pop @function_stack

# == legacy ======================================

subcode: parse_function_list
    $call check_autoload_h
    $if !$autoload_h
	my @tlist=split /,\s*/, $param
	$foreach $f in @tlist
	    $call parse_function_list_item, $f
	    $call add_to_autoload_h, "function-$f"


