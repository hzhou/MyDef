subcode:: package_globals
    $global %basic_types
    %basic_types=(
	"int"=>1,
	"char"=>1,
	"unsigned"=>1,
	"unsigned char"=>1,
	"long"=>1,
	"float"=>1,
	"double"=>1,
    );
    $global %type_name, %type_prefix
    $global %fntype
    %type_name=(
	c=>"unsigned char",
	i=>"int",
	j=>"int",
	k=>"int",
	m=>"int",
	n=>"int",
	l=>"long",
	f=>"float",
	d=>"double",
	count=>"int",
    );
    %type_prefix=(
	i=>"int",
	n=>"int",
	n1=>"int8_t",
	n2=>"int16_t",
	n4=>"int32_t",
	n8=>"int64_t",
	ui=>"unsigned int",
	u=>"unsigned int",
	u1=>"uint8_t",
	u2=>"uint16_t",
	u4=>"uint32_t",
	u8=>"uint64_t",
	c=>"unsigned char",
	uc=>"unsigned char",
	b=>"int",
	s=>"char *",
	v=>"unsigned char *",
	f=>"float",
	d=>"double",
	"time"=>"time_t",
	"file"=>"FILE *",
	"strlen"=>"STRLEN",
	"has"=>"int",
	"is"=>"int",
    );

    $global %stock_functions
    %stock_functions=(
	"printf"=>1,
    );

    $global %lib_include, %type_include, %text_include
    %lib_include=(
	glib=>"glib",
    );

    %type_include=(
	time_t=>"time",
	int8_t=>"stdlib",
	int16_t=>"stdlib",
	int32_t=>"stdlib",
	int64_t=>"stdlib",
	uint8_t=>"stdlib",
	uint16_t=>"stdlib",
	uint32_t=>"stdlib",
	uint64_t=>"stdlib",
    );

    # TODO: limit to function call?
    #-- deprecated, directly test in expression.def
    %text_include=(
	"printf|perror"=>"stdio",
	"malloc"=>"stdlib",
	"str(len|dup|cpy)|memcpy"=>"string",
	"\\bopen\\("=>"fcntl",
	"sin|cos|sqrt|pow"=>"math",
	"fstat"=>"sys/stat",
	"assert"=>"assert",
    );

subcode:: c_support_subs
    $sub infer_c_type
	my $val=shift;
	$if $val=~/^\((float|int|char|unsigned .*|.+\*)\)/
	    return $1
	$elif $val=~/^\((.*)/
	    return infer_c_type($1)
	$elif $val=~/^[+-]?\d+\./
	    return "float"
	$elif $val=~/^[+-]?\d/
	    return "int"
	$elif $val=~/^"/
	    return "char *";
	$elif $val=~/^'/
	    return "char";
	$elif $val=~/^\((\w+)\)\w/
	    return $1
	$elif $val=~/(\w+)\(.*\)/
	    my $func=$functions{$1}
	    return $func->{ret_type}
	$elif $val=~/(\w+)(.*)/
	    my $type=get_var_type($val)
	    return $type

    $sub type_default($type)
	$if $type=~/\*$/
	    return "NULL"
	$elif $type=~/float|double/
	    return "0.0"
	$elif $type=~/char|signed|int/
	    return "0"
	$else
	    return undef


subcode:: c_support_subs
    $sub get_c_type_word($name)
	$if $name
	    $if $type_prefix{$name}
		my $type=$type_prefix{$name}
		return $type

	    $if $name=~/^([a-z0-9]+)/
		my $prefix=$1;
		$if $type_prefix{$prefix}
		    return $type_prefix{$prefix};
		$elif $prefix=~/^(.*?)\d+$/ and $type_prefix{$1}
		    return $type_prefix{$1};
		$elif $structs{$1}
		    return "struct $1"

	    $if substr($name, 0, 1) eq "t"
		return get_c_type_word(substr($name,1));
	    $elif substr($name, 0, 1) eq "p"
		return get_c_type_word(substr($name,1)).'*';
	return undef

    $sub get_c_type
	my $name=shift;
	my $check;
	my $type="void";
	$if $name=~/.*\.([a-zA-Z].+)/
	    #print "ctype: $name->$1\n";
	    $name=$1;
	$if $type_name{$name}
	    $type= $type_name{$name};
	$elsif $name=~/(\w+?)_(.*)/
	    my ($t1, $t2)=($1, $2)
	    my $t=get_c_type_word($t1)
	    $if $t1 eq "t" or $t1 eq "temp"
		$type=get_c_type_word($t2)
	    $elif $t1 eq "p" or $t1 eq "tp"
		$type=get_c_type_word($t2).'*'
	    $else
		$type=get_c_type_word($t1)
	$else
	    $type=get_c_type_word($name)

	$if !$type
	    $type="void";
	$elif $type =~/^\*/
	    $type="void";
	#----------------------------------------  
	$if $type_include{$type}
	    $call add_include, $type_include{$type}
	# --
	$while $name=~/\[.*?\]/g
	    $type=pointer_type($type);
	# --
	$if $debug eq "type"
	    print "    get_c_type:   $name: $type\n";
	return $type;

    $sub name_with_prefix($name)
	$if $name=~/^(t_?)*(p_?)*([a-zA-Z][a-zA-Z0-9]*)\_/
	    my $prefix=$3
	    $if $debug eq "type"
		print "name_with_prefix: $prefix - $type_prefix{$prefix}\n"
	    $if $type_prefix{$prefix}
		return 1
	return 0

subcode:: c_support_subs
    $sub pointer_type($t)
	$t=~s/\s*\*\s*$//;
	return $t;

    $sub get_name_type
	my $t=shift
	$if $t=~/(\S.*\S)\s+(\S+)/
	    return ($1, $2)
	$else
	    return (get_c_type($t), $t)

    # --------------------------------------------
    $sub get_var_fmt($v, $warn)
	my $type=get_var_type($v)
	$if !$type or $type eq "void"
	    $type=get_c_type($v);
	$if $type=~/^char \*/
	    return "\%s";
	$elsif $type=~/\*\s*$/
	    return "\%p";
	$elsif $type=~/^(float|double)/
	    return "\%g"
	$elsif $type=~/(int|long)\s*$/
	    return "\%d";
	$elsif $type=~/^unsigned char/
	    return "\%d";
	$elsif $type=~/char/
	    return "\%c";
	$else
	    $if $warn
		$call warn, get_var_fmt: unhandled $v - $type
	    return undef

