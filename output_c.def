include: output.def
include: macros_c/parsing.def
include: macros_c/last_checks.def
include: macros_c/structure.def
include: macros_c/functions.def
include: macros_c/variables.def
include: macros_c/hash_and_list.def
include: macros_c/types.def
include: macros_c/dump.def
include: macros_c/dump_h.def
# include: macros_c/regex.def

include: macros_c/allocate.def
include: macros_c/list_functions.def


subcode:: package_globals
    use MyDef::dumpout;
    my $cur_indent;
    ## -------------------------------------------------
    $global %misc_vars;
    our $except;

subcode:: support_subs
    $call c_support_subs

page: output_c, output_main
    type: pm
    output_dir: lib/MyDef
    ext: c
    package: MyDef::output_c

    subcode: init_page
	$if $MyDef::def->{"macros"}->{"use_double"}
	    $type_name{f}="double";
	    $type_prefix{f}="double";
	MyDef::dumpout::init_funclist();
	$call @c_init

    subcode: parsecode
	$global $case_flag="b_flag_case"
	$global $case_flag_set="b_flag_case=1;"
	$global $case_flag_reset="b_flag_case=0;"
	global_add_var($case_flag)
	$(set:parse_condition=1)
	$call parsecode_case_support, if, else if, c_style
	$call parsecode_common

    subcode: dumpout
	# ----  Main Function -------------------
	my $mainfunc=$functions{"main"};
	$if $mainfunc
	    $mainfunc->{skip_declare}=1;
	    $mainfunc->{ret_type}="int";
	    $mainfunc->{param_list}=["int argc", "char** argv"];
	    unshift @{$mainfunc->{init}}, "DUMP_STUB main_init"
	    push @{$mainfunc->{finish}}, "DUMP_STUB main_exit", "return 0;"

	# ---- process_function ------------------------
	my $funclist=MyDef::dumpout::get_func_list()
	$foreach $func in @$funclist
	    $if !$func->{processed}
		process_function_std($func)

	$call process_extern_binary
	$call dump_Makefile

	# ---- Header stuff --------------------------
	unshift @$out, "\n/**** END GLOBAL INIT ****/\n"
	unshift @$out, "DUMP_STUB global_init"

	$if $page->{autoload} eq "h"
	    $includes{"\"autoload.h\""}=1
	    #unshift @$out, "#include \"autoload.h\""

	$call c_dump_init

    subcode: dump_Makefile
	$if $mainfunc
	    my $ofile=$page->{outdir}."/Makefile"
	    $if !-f $ofile or $page->{makefile}
		print "  ---> $ofile\n"
		my @objlist
		my @liblist
		$foreach $i in keys %objects
		    $if $i=~/^lib(.*)/
			push @liblist, "-l$1"
		    $elif $i=~/(.*\.o)/
			push @objlist, "$i"
		my $pagename=$page->{pagename}
		open Subfile, ">$ofile" or die "Can't write $ofile\n"
		$call set_make_macro, CC, gcc
		$call set_make_macro, CFLAGS, -
		$call set_make_macro, INC, -
		$call set_make_macro, LIB, -
		$if $page->{makefile} eq "debug"
		    print Subfile "CFLAGS+= -g"
		print Subfile "\n"
		print Subfile "$pagename: $pagename.o ".join(" ", @objlist)."\n";
		print Subfile "\t\$\(CC) \$\(LIB) ".join(" ",@liblist)." -o $pagename \$^\n"
		print Subfile "\n"
		print Subfile "%.o: %.c\n"
		print Subfile "\t\$\(CC) -c \$\(CFLAGS) \$\(INC) -o \$@ \$<\n"
		close Subfile

subcode: set_make_macro(name, default)
    $if $page->{$(name)}
	print Subfile "$(name)=$page->{$(name)}\n"
    $(if:default!=-)
	$else
	    print Subfile "$(name)=$(default)\n"

