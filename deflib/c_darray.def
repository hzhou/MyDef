# dynamic array ----------------------------------------------------
#     function does  not work because we want flexible element types

subcode: local_darray(type, var)
    $local $(type) * $(var)=NULL
    $local n_da_len_$(var)=0
    $local n_da_size_$(var)=0

subcode: global_darray(type, var)
    $global $(type) * $(var)=NULL
    $global n_da_len_$(var)=0
    $global n_da_size_$(var)=0

subcode: use_darray(var)
    $(export: da_len=n_da_len_$(var))
    $(export: da_size=n_da_size_$(var))

# ----------------------------------------------------
subcode: darray_init(var)
    $(var)=NULL
    n_da_len_$(var)=0
    n_da_size_$(var)=0

subcode: darray_clear(var)
    free($(var))
    $call darray_init, $(var)

# ----------------------------------------------------
subcode: darray_check(var)
    $(export:da_len=n_da_len_$(var))
    $(export:da_size=n_da_size_$(var))

    $if $(da_len)+1>$(da_size)
	$my tn_temp
	tn_temp=(int)($(da_size)*2/3)
	$if tn_temp<64
	    tn_temp=64
	$call darray_expand_n, $(var), tn_temp

subcode: darray_check_n(var, n)
    $if n_da_len_$(var)+$(n)>n_da_size_$(var)
	$call darray_expand_n, $(var), n_da_len_$(var)+$(n)-n_da_size_$(var)
    
subcode: darray_expand_n(var, n)
    $get_pointer_type(type) $(var)
    n_da_size_$(var)+=$(n)
    $(var)=($(type) *)realloc($(var), n_da_size_$(var)*sizeof($(type)))
    $call @assert, $(var)

# ----------------------------------------------------
