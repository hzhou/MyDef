subcode: cg_start
    $(export:ctx=cgcontext)
    cgcontext=UIGraphicsGetCurrentContext()

subcode: roundrect(x, y, w, h, r)
    $call move_to, $(x)+$(r), $(y)
    $call line_to, $(x)+$(w)-$(r), $(y)
    $call curve_to, $(x)+$(w), $(y), $(x)+$(w), $(y)+$(r)

    $call line_to, $(x)+$(w), $(y)+$(h)-$(r)
    $call curve_to, $(x)+$(w), $(y)+$(h), $(x)+$(w)-$(r), $(y)+$(h)
    $call line_to, $(x)+$(r), $(y)+$(h)
    $call curve_to, $(x), $(y)+$(h), $(x), $(y)+$(h)-$(r)
    $call line_to, $(x), $(y)+$(r)
    $call curve_to, $(x), $(y), $(x)+$(r), $(y)
    $call closepath

subcode: set_lw(lw)
    CGContextSetLineWidth($(ctx), $(lw))

subcode: set_gray(v)
    CGContextSetRGBStrokeColor($(ctx), $(v), $(v), $(v), 1.0)

subcode: set_gray_fill(v)
    CGContextSetRGBFillColor($(ctx), $(v), $(v), $(v), 1.0)

subcode: move_to(x, y)
    CGContextMoveToPoint($(ctx), $(x), $(y))

subcode: line_to(x, y)
    CGContextAddLineToPoint($(ctx), $(x), $(y))

subcode: curve_to(x1, y1, x2, y2)
    CGContextAddQuadCurveToPoint($(ctx), $(x1), $(y1), $(x2), $(y2))

subcode: stroke
    CGContextStrokePath($(ctx))

subcode: fill
    CGContextFillPath($(ctx))

subcode: clip
    CGContextClip($(ctx))

subcode: cgsave
    CGContextSaveGState($(ctx))

subcode: cgrestore
    CGContextRestoreGState($(ctx))

subcode: strokefill
    $register_name(cgpathref) CGPathRef
    cgpathref=CGContextCopyPath($(ctx))
    CGContextFillPath($(ctx))
    CGContextAddPath($(ctx), cgpathref)
    CGContextStrokePath($(ctx))

subcode: closepath
    CGContextClosePath($(ctx))

subcode: setfont(name, size)
    CGContextSelectFont($(ctx), "$(name)", $(size), kCGEncodingMacRoman)
    CGContextSetTextMatrix($(ctx), CGAffineTransformMake(1.0,0.0, 0.0, -1.0, 0.0, 0.0))

subcode: showtext(s, len)
    CGContextShowText($(ctx), $(s), $(len))

subcode: text(x, y, s, len)
    CGContextShowTextAtPoint($(ctx), $(x), $(y), $(s), $(len))

subcode: text_center(x, y, w, s, len)
    CGContextSetTextDrawingMode($(ctx), kCGTextInvisible)
    CGContextShowTextAtPoint($(ctx), 0, $(y), $(s), $(len))
    tf_text_width=CGContextGetTextPosition($(ctx)).x
    CGContextSetTextDrawingMode($(ctx), kCGTextFill)
    CGContextGetTextPosition($(ctx), $(x)+($(w)-tf_text_width)/2, $(y), $(s), $(len))

subcode: text_right(x, y, s, len)
    CGContextSetTextDrawingMode($(ctx), kCGTextInvisible)
    CGContextShowTextAtPoint($(ctx), 0, $(y), $(s), $(len))
    tf_text_width=CGContextGetTextPosition($(ctx)).x
    CGContextSetTextDrawingMode($(ctx), kCGTextFill)
    CGContextGetTextPosition($(ctx), $(x)-tf_text_width, $(y), $(s), $(len))

subcode: textpos(x, y)
    pt_pos=CGContextGetTextPosition($(ctx))
    $(x)=pt_pos.x
    $(y)=pt_pos.y

subcode: nss_text(x, y, s)
    CGContextShowTextAtPoint($(ctx), $(x), $(y), [$(s) cStringUsingEncoding:kCGEncodingMacRoman], [$(s) lengthOfBytesUsingEncoding:kCGEncodingMacRoman])

subcode: textmatrix
    CGContextSetTextMatrix($(ctx), CGAffineTransformMake(1.0,0.0, 0.0, -1.0, 0.0, 0.0))
