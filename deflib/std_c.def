#include: ref_counting.def
include: c_slist.def

## frame
subcode: basic_frame
    $include stdio
    $include stdlib
    $call @global
    $list n_main

# ----
###############################################################
## Utility
subcode: assert(check)
    $if !($(check))
	$call assert_action

subcode: assert_action
    printf("Assert Error: ($(check)) at line %d \n", __LINE__)
    exit(1)

## FILE IO
subcode: mmap(filename, strname, strsize)
    $include sys/mman
    $include sys/stat
    $include fcntl
    $include unistd
    tn_fd=open($(filename), O_RDONLY)
    struct stat st
    fstat(tn_fd, &st)
    $(strsize)=st.st_size
    $(strname)=mmap(0, $(strsize), PROT_READ, MAP_SHARED, tn_fd, 0)
    BLOCK
    munmap($(strname), $(strsize))
    close(tn_fd)

# --------------------------------
subcode: open_w(file)
    file_out=fopen($(file), "w")
    $if file_out==NULL
        fprintf(stderr, "Can't write %s\n", $(file))
    $else
        BLOCK
        fclose(file_out)
subcode: open_r(file)
    file_in=fopen($(file), "r")
    $if file_in==NULL
        fprintf(stderr, "Can't open %s\n", $(file))
    $else
        BLOCK
        fclose(file_in)

# --------------------------------
subcode: write_sig(name)
    t_n=fwrite("$(name)", 1, $(name:len), file_out)
subcode: write_var(name)
    t_n=fwrite(&$(name), sizeof($(name)), 1, file_out)

subcode: read_var(name)
    t_n=fread(&$(name), sizeof($(name)), 1, file_in)

# --------------------------------
perlcode: tempstr
    my ($n, $fmt)=fmt_string($param)
    $if $n>0
	func_add_var("ts_temp_buf[100]", "local")
	push @$out, "snprintf(ts_temp_buf, 100, $fmt);"
	MyDef::compileutil::set_current_macro("tempstr", "ts_temp_buf")
    $else
	MyDef::compileutil::set_current_macro("tempstr", $fmt)

