fncode: parse_template($def, $template_file)
    $call check_path

    $global $template_idx=0
    $template_idx++
    my $cur_source=[]
    my $codes = $def->{codes}
    $codes->{"_T$template_idx"} = {type=>'template', source=>$cur_source, 'params'=>[]}
    $call read_source
    return "_T$template_idx"

    #---------------------------------------- 
    subcode: read_source
        &call open_r, $template_file
            $if /^\s*DUMP_STUB\s+(\w+)/
                $page->{"has_stub_$1"}=1
            push @$cur_source, $_

    subcode: check_path
        my $template_dir
        $if $def->{macros}->{TemplateDir}
            $template_dir=$def->{macros}->{TemplateDir}
        $elif $MyDef::var->{TemplateDir}
            $template_dir=$MyDef::var->{TemplateDir}

        $if $template_dir
            $if $template_file!~/^\.*\//
                $template_file = $template_dir.'/'.$template_file
