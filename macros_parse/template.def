fncode: get_template_sub_name
    $global $template_index = 0
    my $sub_name = "TMP_$template_index"
    $template_index++
    return $sub_name

fncode: parse_template($def, $pagecodes, $template_file, $sub_name)
    $call check_path

    my @new_source
    push @new_source, "subcode: $sub_name"

    my $t_idx = 0
    $call start_template

    my $cur_grab_spaces
    my $start_grab
    my $cur_grab
    &call open_r, $template_file
        $if $start_grab
            $if /^\s*$/
                push @$cur_grab, $_
            $elif /^(\s*)(.*)/
                my $n= get_indent_spaces($1)
                $if $n <= $cur_grab_spaces
                    # -- end of grab 
                    $if $start_grab eq "mydef"
                        $call insert_grab_mydef
                        $call start_template
                        $call append_template
                    undef $start_grab
                    next
                $else
                    my $new_spaces = $n-$cur_grab_spaces
                    $if $start_grab eq "mydef"
                        $if $new_spaces<4
                            push @$cur_grab, "    $2\n"
                        $else
                            push @$cur_grab, ' 'x$new_spaces . "$2\n"
                    $elif $start_grab eq "template"
                        $if $new_spaces<4
                            push @$cur_grab, "$2\n"
                        $else
                            push @$cur_grab, ' 'x($new_spaces-4) . "$2\n"


        $elif /^(\s*)(mydef):/
            $cur_grab_spaces=get_indent_spaces($1)
            $start_grab = $2
            $cur_grab=[]
        $elif /^(\s*)template:\s*(\w+)/
            $cur_grab_spaces=get_indent_spaces($1)
            $start_grab = "template"
            $cur_grab=[]
            $pagecodes->{$2}={type=>"template", source=>$cur_grab, 'params'=>[]}
        $else
            $if /^\s*DUMP_STUB\s+(\w+)/
                $page->{"has_stub_$1"}=1
            $call append_template

    return \@new_source

    #---------------------------------------- 
    subcode: check_path
        my $template_dir
        $if $def->{macros}->{TemplateDir}
            $template_dir=$def->{macros}->{TemplateDir}
        $elif $MyDef::var->{TemplateDir}
            $template_dir=$MyDef::var->{TemplateDir}

        $if $template_dir
            $if $template_file!~/^\.*\//
                $template_file = $template_dir.'/'.$template_file

    subcode: insert_grab_mydef
        my $len = $cur_grab_spaces
        my $n=int($len/4)
        $if $len % 4
            $n++
        $for $i=0:$n
            push @new_source, "    INDENT"
        push @new_source, @$cur_grab
        $for $i=0:$n
            push @new_source, "    DEDENT"

    subcode: start_template
        $t_idx++
        my $cur_source=[]
        $pagecodes->{"_T_$t_idx"} = {type=>'template', source=>$cur_source, 'params'=>[]}
        push @new_source, "    \$call _T_$t_idx"

    subcode: append_template
        push @$cur_source, $_
        
            
