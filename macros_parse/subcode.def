
subcode: subcode_start
    $call get_parent, codes
    my $t_code

    expand_macro(\$line, $macros)
    $if $line=~/^(\w+)code:([:-@]?)\s*(\w+)/
        my ($type, $dblcolon, $name)=($1, $2, $3)
        my $t = $';
        $if $t=~/^(\.\w+)/
            # fncode: class.method
            $name .= $1
            $t = $';
        #---- $dblcolon -----------
        #-        :: concat
        #-        :@ optional default
        #-        :- prepend
        $if $name eq "_autoload" or $name eq "main"
            $dblcolon=":"
        # $call @debug
        $call start_subcode

    subcode: debug
        $print $type code $name, parent: -
        $if $parent == $def
            $print def
        $elif $parent->{_pagename}
            $print page: $parent->{_pagename}
        $else
            $print code: $parent->{name}

#---------------------------------------- 
subcode:: import_file_init
    my $source
    my $code_prepend

subcode: start_subcode
    ### htmlcode, jscode, subcode, phpcode, fncode
    my $src_location="SOURCE: $cur_file - $cur_line";
    $source=[$src_location];

    # -------------------
    undef $code_prepend

    $(set:code=$codes->{$name})
    $(set:attr=$(code)->{attr})
    $if $(code) and (!$(attr) or $(attr) ne "default")
        $t_code=$codes->{$name}
        # Subcode Already Exist --
        $if $dblcolon eq "@"
            # -- skip the default subcode
        $elif $dblcolon eq ":"
            # -- append
            $source=$t_code->{source}
            push @$source, $src_location
        $elif $dblcolon eq "-"
            # -- prepend
            $code_prepend=$t_code->{source}
            $t_code->{source} = $source
        $elif $(attr) and $(attr) eq "optional"
            # -- append and finalize
            $t_code->{attr}=undef
            $source=$t_code->{source}
            push @$source, $src_location
        $elif $debug>1
            # -- skip
            my $last_src = $(code)->{source}->[0]
            print STDERR "[$src_location] skip duplicate code: $name [$last_src]\n"
    $else
        #---- new code or overwrite ----
        my @params;
        $if $t=~/^\s*\((.*)\)(.*)/
            $t=$2
            @params=split /,\s*/, $1;

        $global $code_index=0
        $code_index++
        $t_code={'type'=>$type, 'index'=>$code_index, 'source'=>$source, 'params'=>\@params, 'name'=>$name};

        $if $t=~/^\s*:\s*(.+)/
            $t_code->{tail} = $1

        $if $dblcolon eq "@"
            $t_code->{attr}="default"
        $elif $dblcolon eq ":" or $dblcolon eq "-"
            $t_code->{attr}="optional"

        $codes->{$name}=$t_code

subcode: check_subcode_end
    $call get_source_dedent, $codeindent
    $if $code_prepend
        push @$source, @$code_prepend

#---------------------------------------- 
subcode: jump_to_main_code
    $call add_main_code
    $call start_code_indent, code, $curindent, $t_code

    push @$source, "SOURCE: $cur_file - ".($cur_line-1)
    push @$source, $line

subcode: add_main_code
    my $t_code
    $if $page->{codes}->{main}
        $t_code = $page->{codes}->{main}
        $source = $t_code->{source}
    $else
        $source=[]
        $t_code={'type'=>"sub", 'source'=>$source, 'name'=>"main"};
        $page->{codes}->{main}=$t_code

